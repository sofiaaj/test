---
title: "Risk outline - Reproducible Version"
output: pdf_document
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE)
```

```{r, warning=FALSE, message=FALSE,echo=FALSE}
library(dplyr)
library(knitr)
library(binsreg)
library(readr)
library(tidyr)
library(plyr)
library(zoo)
library(ggplot2)
library(xtable)
library(stargazer)
library(reticulate)
library(tidycensus)
library(gridExtra)
library(kableExtra)
library(naniar)
library(psych)
library(broom)
library(purrr)
library(mice)
library(fastDummies)
library(wesanderson)
library(extrafont)
library(stringr)
library(missForest)
```

## 1. Data overview

**Job risk model**

We use Pulse data from phase 3.1, 3.2, and 3.3. The data for these phases pertain to data collected across the following periods:

* Phase 3.1: April 14, 2021 – July 5, 2021
*	Phase 3.2: July 21, 2021 – October 11, 2021
*	Phase 3.3: December 1, 2021 – February 7, 2022
* Phase 3.4: March 2, 2022 - May 9, 2022

Pulse surveys prior to phase 3.1 do not contain the question about the job setting of respondents that allows us to categorize employees.


**Omicron concerns + impetus for creating risk of infection by specific severity levels**

The period starting from mid-Phase 3.3 and continuing for phase 3.4 contains data collected during a time of high prevalence of the Omicron variant. Using CDC data on variant proportions, we see that beginning with the week ending on December 27, 2021, the Omicron variant constituted over half of all COVID infections of the US.

```{r}
read.csv("data_files/covid/covid_variant_proportions.csv") %>%
  filter(modeltype == "smoothed") %>%
  group_by(week_ending,variant) %>%
  arrange(desc(published_date)) %>%
  slice(1:1) %>%
  mutate(week_ending = as.Date(substr(week_ending,1,10),format="%m/%d/%Y"),
         published_date = as.Date(substr(published_date,1,10),format="%m/%d/%Y"),
         variant = case_when(
           variant == "BA.1.1" ~ "Omicron",
           variant == "BA.2" ~ "Omicron",
           variant == "B.1.1.529" ~ "Omicron",
           variant == "BA.2.12.1" ~ "Omicron",
           variant == "B.1.1.7" ~ "Alpha",
           variant == "AY.1" ~ "Delta",
           variant == "AY.2" ~ "Delta",
           variant == "B.1.617.2" ~ "Delta",
           variant == "Other" ~ "Other")) %>%
  ggplot(aes(x=as.Date(week_ending),y=share,fill=variant,col=variant)) + 
  geom_col() +
  scale_x_date(date_breaks = "weeks") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(text = element_text(family = "Georgia",size=9)) +
  geom_hline(yintercept=0.5) + 
  labs(x = "Date",y = "Share Infections",title = "Variant Proportions")
```

```{r,echo=FALSE}
ggsave("figures/variant_proportions.png")
```

Because of the highly contagious nature of the variant, we worried readers might think that merely getting infected isn't a big deal given the high share of adults infected at least once. We are also interested in measuring the absolute amount of noxiousness and how it compares to the pre-pandemic period, which means we need a risk measure that is comparable to the types of workplace risk that existed prior to the pandemic. It makes sense to think of an injury ending in death in the same way we think about a covid infection ending in death, but comparing a non-fatal injury such as a cut or laceration with a mild case of covid, or a bad fracture with a case of long covid, is less straightforward.
We resolve this apples-to-apples issue by converting the risk of a covid infection to the risk of a mild to moderate infection or a covid hospitalization. We also calculate the risk for the infection to result in a case of long covid. For each type of infection severity, we can give an estimate for the number of days away from work resulting from it by using data on the average recovery time for each type. Finally, we use BLS data collected prior to the pandemic that records the total number of injuries recorded in each industry and the respective recovery times. The bottomline: if a covid infection contracted on the job took 15 days to recover from, we argue the severity of the infection is comparable to a workplace injury that resulted in the worker taking 15 days away from the job.


## 2. Process Pulse data

**Creating job categories**

We start by assigning a job category to each respondent. We create job categories by combining the type of work the respondent does and their education level. An important point: we only keep respondents who were 18 or older at the time of being surveyed.

1. Work in the last 7 days
    + Variable name: any_work
    + Phase 3.1, 3.2, 3.3 and 3.4: "In the last 7 days, have you done any work for pay or profit?"

2. Work outside the home
    + Variable name: work_outside_home
    + Phase 3.1: "Since January 1, 2021, have you worked or volunteered outside your home?"
    + Phase 3.2, 3.3, and 3.4: "In the last 7 days, have you worked or volunteered outside your home?"

3. Setting of work outside home
    + Variable name: setting
    + Phase 3.1: "Since January 1, 2021, which best describes the primary location/setting where you worked or volunteered outside your home?"
    + Phase 3.2, 3.3, and 3.4: "In the last 7 days, which best describes the primary location/setting where you worked or volunteered outside your home?"

4. Reason not work for pay or profit
    + Variable name: reason_not_work
    + Phase 3.1, 3.2, 3.3, and 3.4: "What is your main reason for not working for pay or profit?"

**Categorization**

* In-person workers
    + Has worked in the last 7 days (any_work = 1)
    + Worked or volunteered outside the home (work_outside_home = 1)

* Remote workers
    + Has worked in the last 7 days (any_work = 1)
    + Has not worked or volunteered outside the home (work_outside_home = 2)

* Unemployed
    + Has not worked in the last 7 days (any_work = 2)
    + Main reason for not working for pay or profit:
        - Was concerned about getting or spreading the coronavirus (reason_not_work = 5)
        - Was laid off or furloughed due to coronavirus pandemic (reason_not_work = 8)
        - Employer closed temporarily due to coronavirus pandemic (reason_not_work = 9)
        - Employer went out of business due to coronavirus pandemic (reason_not_work = 10)
        - I do/did not have transportation to work (reason_not_work = 11)

* NILF
    + Has not worked in the last 7 days (any_work = 2)
    + Main reason for not working for pay or profit:
        - I did not want to be employed at this time (reason_not_work = 1)
        - I am/was sick with coronavirus symptoms or caring for someone who was sick with coronavirus symptoms (reason_not_work = 2)
        - I am/was caring for children not in school or daycare (reason_not_work = 3)
        - I am/was caring for an elderly person (reason_not_work = 4)
        - I am/was sick (not coronavirus related) or disabled (reason_not_work = 6)
        - I am retired (reason_not_work = 7)
        - Other reason, please specify (reason_not_work = 12)
        
**Education Levels**
We create 4 education categories:

1. Less than high school graduate
2. High school graduate or GED
3. Some college or associate's degree
4. Bachelor's degree or higher

**Combining education and setting data**

For the categories, “Working from home”, “Unemployed”, and “NILF”, we collapse across all 4 education categories as the type of work and riskiness of it should not vary in these categories. Due to the relatively small size of some of these job categories, we also make the following changes to our job categories:

1.	Combine the “less than high school” and “high school” categories for “correctional facilities”.
2.	Combine the 4 “health care” and 4 “death care” categories into 4 “health and death care” categories. 
3.	Combine the “less than high school” and “high school” categories for public transit.
4.	Combine the “less than high school” and “high school” categories for USPS.

We arrive at a final list of 60 job categories.

![Job categories]("figures/job_categories.png")

Loading Pulse data, selecting relevant variables, renaming, and cleaning:

```{r,message=FALSE,warning=FALSE}
clean_vars <- read.csv("data_files/cleanvariables/pulse/pulse_cleanvars.csv")
recode_vars <- read.csv("data_files/cleanvariables/pulse/pulse_recode.csv")
set_educ_to_job <- read.csv("data_files/cleanvariables/pulse/pulse_setting_education_to_job.csv") %>% mutate(setting = tolower(setting))
```

```{r}
open <- function(phase){
  filepath = paste0("data_files/pulse/phase",as.character(phase),"/")
  df <- list.files(path = filepath,
           pattern = "*.csv",
           full.names = T) %>% 
    map_df(~read_csv(.)) %>% 
  dplyr::select(clean_vars[clean_vars$phase == phase,]$pulsename) %>% 
  purrr::set_names(clean_vars[clean_vars$phase == phase,]$newname)
  return(df)
}
```


```{r}
recode <- function(df,x,curr_phase){
  df <- merge(df,recode_vars %>%
          filter(type == x & phase == curr_phase) %>%
          select(-phase) %>%
          dplyr::rename({{x}} := oldvar),all.x = TRUE)
  return(df)
}
```

Clean up data steps:

* Removed respondents born after 2003
* Removed respondents missing responses necessary for categorization (vaccine status, whether they work outside the home, reason for not working)
* Categorizing remote workers, nilf, and unemployed
* Recoding variables from numbers to text

```{r}
clean <- function(df, phase){
 nilf <- c(1,2,3,4,6,7,12)
 df <- df %>% 
  filter(birth_year <= 2003 & work_outside_home > 0 & setting != -99 & reason_not_work != -99) %>%
  mutate(setting = case_when(
    work_outside_home == 2 & any_work == 1 ~ 20,
    any_work == 2 & !(reason_not_work %in% nilf) ~ 21,
    any_work == 2 & reason_not_work %in% nilf ~ 22,
    TRUE ~ setting)) %>%
  filter(setting > 0) %>%
  mutate(race_ethnicity = if_else(hisp_ethnicity == 2,5,race)) %>%
  left_join(unique(get(data("fips_codes")) %>% 
              select(state_code,state_name) %>% 
              dplyr::rename("state" = "state_code"))) %>%
  select(-state) %>% 
  dplyr::rename(state = state_name)
 
 for(x in unique(recode_vars$type)){
   df <- recode(df,x,phase) %>% 
     select(-type,-{{x}}) %>%
     dplyr::rename({{x}} := newvar) 
 }
 return(df)
}
```

Combining setting information with education level to create job categories. 

```{r}
make_job <- function(df){
  df <- merge(df,set_educ_to_job,by=c("setting","education"))
  return(df)
}
```

```{r}
process <- function(phase){
  df <- open(phase)
  df <- clean(df,phase)
  df <- make_job(df)
  return(df)
}
```

Obtaining clean data files:

```{r}
phase3.1 <- process(3.1)
phase3.2 <- process(3.2)
phase3.3 <- process(3.3)
phase3.4 <- process(3.4)
```


Exporting processed files:

```{r}
write.csv(phase3.1,"data_files/pulse/processed/phase3.1.csv",na="Missing")
write.csv(phase3.2,"data_files/pulse/processed/phase3.2.csv",na="Missing")
write.csv(phase3.3,"data_files/pulse/processed/phase3.3.csv",na="Missing")
write.csv(phase3.4,"data_files/pulse/processed/phase3.4.csv",na="Missing")
```

Merge all phases and export:

```{r}
pulse <- rbind(phase3.1,
               phase3.2,
               phase3.3,
               phase3.4)
```

```{r}
write.csv(pulse,"data_files/pulse/processed/full_pulse")
```


#### Sanity checking telework

Doing a sanity check the latter phases, "In the last 7 days, have you or your household done any of the following… Teleworked or worked from home?" we find that 34% of our "WFH" employees said they didn't work from home.

To handle these “inconsistent” responses, we treat it as missing impute these settings by using a respondent’s age, education level, household income, etc. to predict the missing setting.


```{r}
temp_merge <- rbind(phase3.2,phase3.3,phase3.4)
temp_merge %>%
  filter(setting == "working from home" & teleworked > 0) %>%
  mutate(teleworked = if_else(teleworked == 1,"Yes","No")) %>%
  dplyr::group_by(teleworked) %>%
  dplyr::summarise(count = n()) %>%
  mutate(percent_teleworked = count/sum(count)) %>%
  ggplot(aes(x=teleworked,
             y=percent_teleworked)) + 
  theme_minimal() + 
  labs(x="In the last 7 days, have you or your household teleworked?",
       y="% of work from home respondents",
       title = "Inconsisent categorization",
       subtitle = "Respondents who indicated they worked but didn't work in-person or at home") + 
  geom_col(color = "black",
           fill="slategray3",
           size=0.4,
           width=0.6) +
  geom_text(aes(label=round(percent_teleworked,2)), 
            position=position_dodge(width=0.9), 
            vjust=-0.5) +
  theme(text = element_text(family = "Georgia",
                            size=9))
```


```{r}
ggsave("figures/inconsisent_responses.png")
```

```{r}
temp_merge <- temp_merge %>% 
  dplyr::mutate(setting = as.character(setting),
                setting = if_else((setting == "working from home" & teleworked == 2),
                                  "missing",
                                  setting)) %>%
  replace_with_na(replace = list(setting = "missing"))
```

```{r}
pulse_grouped <- temp_merge %>%
  mutate_if(is.character, as.factor)
```

```{r}
write.csv(pulse_grouped,"data_files/pulse/processed/all_phases.csv")
```

Using missForest (random forest algorithm implementation) to impute missing values:

```{r}
#imputed <- missForest(pulse_grouped %>% select(-job))
imputed <- na.omit(pulse_grouped)
```

```{r}
pulse_grouped <- read_csv("data_files/pulse/processed/all_phases.csv")
```


## 3. Relative Risk
### 3.1. Relative risk: Esimate hours in each setting

Having categorized Pulse respondents into their respective work categories, we now want to create a model to estimate the relative covid risk for different workers. Because we are ultimately interested in understanding risk specific to the workplace, we want to distribute infections between those occurring at work, leisure, or at home. To do this, we take the following steps:

Under the assumption that spending more time in a certain setting increases ones probability of contracting covid in it, we first go about estimating the number of hours a respondent spends at home, leisure, and the workplace. To do this, we use pooled state-level ATUS data and determine the average number of hours respondents in each work status (NILF, unemployed, employed remote, employed in-person) spend in the three settings.

The first step is to prepare the ATUS data, categorizing respondents into the work statuses of interest.

#### 3.1.1. Processing ATUS data:

* Respondent file contains information on labor status obtained from CPS. We use this to categorize as we do CPS data.
    + emp_status: 1 = Employed, at work. 2 = Employed, absent. 3 = Unemployed, on layoff. 4 = Unemployed, looking. 5 = Not in labor force.
    + industry: census industry codes
    + occupation: census occupation codes

```{r}
clean_vars <- read.csv("data_files/cleanvariables/atus/atus_cleanvars.csv")
cic_to_pulse <- read.csv("data_files/cps_acs/crosswalk/cic_to_pulse.csv")
coc_to_pulse <- read.csv("data_files/cps_acs/crosswalk/coc_to_pulse.csv")
teleworkable <- read.csv("data_files/cps_acs/crosswalk/teleworkable.csv")
```

```{r}
open <- function(yr,tp){
  filepath = paste0("data_files/atus/",yr,"/atus",tp,"_",yr,".dat")
  clean <- clean_vars %>% filter(type == tp & year == yr)
  df <- read.delim(filepath, header=TRUE, sep=",") %>%
    dplyr::select(clean$atusname) %>%
    purrr::set_names(clean$newname) %>%
    mutate(year = yr)
  return(df)
}
```

```{r}
atusresp <- rbind(open("2020","resp"),
                  open("2021","resp"))
```

We obtain job categories for all ATUS respondents using our CPS crosswalk which matches Census industries and occupations to one of our Pulse settings. As we do in the ATUS, we only categorize a respondent as employed if they've done work for pay or profit in the last 7 days. Workers who aren't employed are categorized as NILF if their reason for not working is that they are retired, disabled, or unable to work.

```{r}
atusresp <- atusresp %>% 
  merge(.,cic_to_pulse,by="industry") %>%
  merge(., coc_to_pulse,by=c("occupation","industry","industry_title"),all.x=TRUE) %>%
  merge(.,teleworkable,by = "occupation",all.x=TRUE) %>%
  mutate(teleworkable = ifelse(is.na(teleworkable),0,teleworkable),
         setting = coalesce(occupation_based_setting,industry_based_setting)) %>% 
  mutate(setting = as.character(setting),
         casied = as.character(caseid)) %>%
  mutate(setting = ifelse(any_work == 2,"Unemployed",
                          ifelse(any_work %in% c(3,4,5),"NILF",setting)))
```

Now we get atus-cps file which contains information on the state and education level of respondents. 

```{r}
#Convert fips codes into state names
fips <- unique(get(data("fips_codes")) %>% 
              select(state_code,state_name) %>% 
              dplyr::rename("state" = "state_code") %>%
              mutate(state = as.numeric(state)))
```

```{r}
atuscps <- rbind(open("2020","cps"),
                 open("2021","cps"))
```

```{r}
# Education variable into our four categories
atuscps <- atuscps %>%
  # File contains responses for household members as well. We filter for atus_respondent = 1, corresponding to person interviewed for ATUS
  filter(atus_respondent == 1) %>%
  merge(.,fips,by="state") %>%
  mutate(state = state_name) %>%
  select(-state_name) %>%
  mutate(caseid = as.character(caseid)) %>%
  mutate(education = case_when(
    education <= 38 ~ "Less than HS graduate",
    education == 39 ~ "HS graduate or GED",
    education > 39 & education <= 42 ~ "Some college or associate's degree",
    education > 42 & education <= 46 ~ "Bachelor's degree or higher"
  ))
```

```{r}
#Merge with respondent file for a complete view:
atusresp <- merge(atusresp %>% mutate(caseid = as.character(caseid)),
                  atuscps %>% mutate(caseid = as.character(caseid)),
                  by=c("caseid","year"))
```

Finally, we can merge with activity data to get time distribution across settings. ATUS activity file includes activity-level information collected in ATUS, including activity code, location, duration, activity start and stop times. 

```{r}
#Note, two different variables available for the cumulative duration of an activity. In the one we use, the last activity is truncated at 4 am.
atusact <- rbind(open("2020","act"),
                 open("2021","act"))
```

Location is not collected for activities with activity codes of 0101xx (sleeping), 0102xx (grooming), 0104xx (personal activites), 500105 (none of your business), or 500106 (gap can't remember). We assume sleeping, grooming, and personal activities occured in the household. Finally, we remove location code 89, "Unspecified place".

```{r}
atusact <- atusact %>%
  mutate(location = ifelse(tier1code == 1 & tier2code %in% c(1,2,3),1,location)) %>%
  filter(location != -1 & location != 89) %>%
  mutate(caseid = as.character(caseid)) %>%
  merge(.,atusresp,by=c("caseid","year"))
```

#### 3.1.2. Categorizing in-person and remote workers

Currently, we categorize workers based on their industry and occupation, but do not specify whether they are remote or in-person. The CPS added a question on whether the respondent did any teleworking:

*"At any time in the LAST 4 WEEKS, did (you/name) telework or work at home for pay BECAUSE OF THE CORONAVIRUS PANDEMIC?*

However, this captures a different set of people than the Pulse, which asks:
 
*“Since January 1, 2021 [or “In the last 7 days” for later surveys], have you worked or volunteered outside your home?"*

Three main differences with the question:

1. In the Pulse, we categorize anyone who worked outside the home at any point as in-person. In the CPS, anyone who worked remotely is remote. E.g., If person X worked 3 days at home and 2 days in-person because of covid policied, they'd be remote in the CPS but in-person in the Pulse.
2. The timeframe for the CPS is the last 4 weeks while the Pulse asks about the last 7 days (for most phases)
3. The CPS only captures those who teleworked *because* of covid.

Because of all the discrepancies, using data from the ATUS itself could be a better stratey to replicate the Pulse question. As a first step we:

* Get all respondents who did work in the last 7 days (i.e., those we label as "employed" in the Pulse)
* From the hours these respondents spent working, calculate how many were in the workplace.
* If a respondent spent *any* time in the workplace, they are categorized as in-person.
* If a respondent spent no time in the workplace, they are categorized as remote.

Why look specifically at the workplace instead of just checking whether the time was spent outside the home? I was worried that a lot of remote workers might spend time working in libraries, coffeeshops, friends houses, trains (while commuting somewhere), etc. Although the Pulse survey only asks if they've worked "outside the home", the question is really asking if they've done in-person work at a workplace setting (hence why the follow-up question asks about the setting). In other words, if a Pulse respondent works remotely at a coffeeshop, they would still be remote for Pulse standards. Thus, determining whether an ATUS respondent spent work time at a workplace was a better way of getting at the in-person Pulse population.

An issue with this strategy is that some respondents did no work on the day they were surveyed (were surveyed on the weekend, etc). For cases where we have no ATUS information, we move on the next "best" data, the CPS question asking if they were remotely. Those who said they teleworked are categorized as remote, those that didn't are in-person.

Finally, due to the non-response rate to the teleworking question on the CPS, as a last resort, we use the Dingel and Neiman categorizations to know if the respondent's job is teleworkable or not.

```{r}
cats <- atusact %>%
  filter(tier1code == 5 & tier2code == 1 & tier3code == 1) %>%
  dplyr::mutate(top_location = ifelse(location == 2,"Workplace","Other")) %>%
  dplyr::group_by(caseid,top_location) %>%
  dplyr::summarize(work_time = sum(duration)) %>%
  dplyr::mutate(work_time = work_time/sum(work_time)) %>%
  spread(top_location,work_time) %>%
  replace(is.na(.),0) %>%
  mutate(inperson = ifelse(Workplace > 0,1,0))
atusact <- atusact %>% 
  mutate(top_category = case_when(
    setting == "NILF" ~ "NILF",
    setting == "Unemployed" ~ "Unemployed",
    caseid %in% cats[cats$inperson == 1,]$caseid ~ "In-person",
    caseid %in% cats[cats$inperson == 0 ,]$caseid ~ "Remote",
    work_at_home == 1 ~ "Remote",
    work_at_home == 2 ~ "In-person",
    teleworkable == 0 ~ "In-person",
    teleworkable == 1 ~ "Remote"
  ))
```

Export processed ATUS file:

```{r}
write.csv(atusact,"data_files/cleanvariables/atus/atus_full.csv")
```



#### 3.1.3. Assess crosswalk

To assess our crosswalk, we can compare the estimated population of remote workers from the Pulse and the ATUS. 

First, we can convert Pulse weeks into months. To keep it simple, I'm categorizing each week based on the month the majority of days fall into. If multiple weeks fall in the same month, I take the average of each week's estimates.

Week 28: April 14 - April 26
Week 29: April 28 - May 10
Week 30: May 12 - May 24
Week 31: May 26 - June 7
Week 32: June 9 - June 21
Week 33: June 23 - July 5
Week 34: July 21 - August 2
Week 35: August 4 - August 16
Week 36: August 18 - August 30
Week 37: September 1 - September 13
Week 38: September 15 - September 27
Week 39: September 29 - October 11

```{r}
wfh_est <- pulse_grouped %>%
  mutate(month = case_when(
    week == 28 ~ 4,
    week == 29 ~ 4,
    week == 30 ~ 5,
    week == 31 ~ 5,
    week == 32 ~ 6,
    week == 33 ~ 6,
    week == 34 ~ 7,
    week == 35 ~ 8,
    week == 36 ~ 8,
    week == 37 ~ 9,
    week == 38 ~ 9,
    week == 39 ~ 10
  )) %>%
  na.omit() %>%
  filter(!(job %in% c("Unemployed","NILF"))) %>%
  dplyr::group_by(month,week,setting) %>%
  dplyr::summarise(total = sum(weight)) %>%
  dplyr::mutate(percent = total/sum(total)) %>%
  dplyr::group_by(month,setting) %>%
  dplyr::summarise(percent = mean(percent)) %>%
  filter(setting == "working from home") %>%
  select(percent) %>%
  mutate(type = "Pulse")
```

```{r}
wfh_est <- rbind(wfh_est,atusact %>%
  filter(month %in% c(4,5,6,7,8,9,10) & year == 2021 & top_category %in% c("In-person","Remote")) %>%
  dplyr::group_by(month,top_category) %>%
  dplyr::summarise(total = sum(weight)) %>%
  dplyr::mutate(percent = total/sum(total)) %>%
  filter(top_category == "Remote") %>%
  select(percent) %>%
  mutate(type = "ATUS"))
```

We can estimate the percent of the population made up by remote workers:

```{r}
wfh_est %>%
  spread(type,percent) %>%
  kable()
```

Our estimate for the ATUS is lower, although the difference is  small and remains somewhat consistent across the months. I would love to know what you think about it!

```{r}
wfh_est %>%
  ggplot(aes(x=month,y=percent,color=type)) + 
  geom_point() + 
  geom_line() + 
  theme_bw() + 
  labs(x="Month",y="% labor force",title = "Remote employee estimate - ATUS vs. Pulse") + 
  theme(text = element_text(family = "Georgia",size=11)) + 
  scale_color_discrete(name = "Focus of chapter") +
  scale_color_manual(values=wes_palette(n=2, name="Zissou1",type="continuous"))
```

Calculating the correlation between the estimates:

```{r}
cor(wfh_est[wfh_est$type == "ATUS",]$percent,wfh_est[wfh_est$type == "Pulse",]$percent)
```

#### 3.1.4. Calculate time in each setting

Having obtained a crosswalk between the ATUS and work categories of interest, we can now estimate the percent of time each group spent at home, at work, and outside the home and workplace ("leisure"). Before this calculation, a question I want to run by you: 

In the Pulse and ATUS, a respondent who does any in-person work will be categorized as "in-person" even if they spend time working at home. This means many of our "in-person" workers will really be *hybrid* workers who do some of their work at home or in "remote workplaces" (eg. coffeeshop). Similarly, in-person workers will spend some work hours outside the home (though not in the workplace). Because our infection proportions are based on settings (home, workplace, leisure (outside home and outside workplace)), we will calculate the average hours in each setting, but when we *divide* infections, we will have to consider time spent working in each setting. 

To give a simple example:

* Remote workers had 10 infections
* Remote workers spent 50% of time at home and 50% time outside the home (not at the workplace). We attribute 5 infections to each setting.
* From time at home, 20% was spent working. From time outside home, 40% of time was spent working. We attribute 3 infections to work.

As a first step, we can calculate time spent in each setting:

```{r}
atusact <- atusact %>%
  mutate(top_location = case_when(
    location == 1 ~ "Home",
    location == 2 & top_category == "In-person" ~ "Workplace",
    TRUE ~ "Leisure"
  )) %>%
  dplyr::mutate(date = as.yearmon(paste(year,month), "%Y %m")) 

time_per_setting <- atusact %>%
  filter(date > "Mar 2020") %>%
  dplyr::group_by(top_location,top_category,caseid,weight) %>%
  dplyr::summarise(time = sum(duration)/60) %>%
  ungroup() %>%
  complete(nesting(caseid,weight,top_category),top_location,fill=list(time=0)) %>%
  group_by(top_location,top_category) %>%
  dplyr::summarise(time = weighted.mean(time,weight)) 

time_per_setting %>%
  filter(time > 0) %>%
  ggplot(aes(x=top_category,y=time,fill=top_location)) + 
  geom_col(position = position_stack(reverse = TRUE),size=0.3,width=0.5,color = "black") + 
  theme_bw() + 
  labs(x="Group",y="Avg. number of hours",title = "Time in each setting by group") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + 
  theme(text = element_text(family = "Georgia",size=12)) +
  scale_fill_manual(name="Setting",values=wes_palette(n=3, name="FantasticFox1",type="continuous"))
```

Exporting time-per-setting:

```{r}
write.csv(time_per_setting,"data_files/cleanvariables/atus/time_per_setting.csv")
```

Now, we can merge our Pulse data with information on time per setting:

```{r}
# Convert Pulse settings into 4 categories (in-person, nilf, remote, unemployed)
pulse <- pulse %>%
  mutate(top_category = case_when(
    setting == "nilf" ~ "NILF",
    setting == "unemployed" ~ "Unemployed",
    setting == "working from home" ~ "Remote",
    TRUE ~ "In-person"
  ))

# Spread time per setting data for easier merging
time_per_setting <- time_per_setting %>%
  mutate(top_location = paste0("Time_At_",top_location)) %>%
  spread(top_location,time)

# Merge data
pulse <- pulse %>%
  merge(.,time_per_setting,by="top_category")
```


#### 3.1.5. Sanity check time in each setting

Because we are averaging time in each setting from across the pandemic period, we risk over or underestimating the number of infections occuring in a given setting. If, for example, the time spent during leisure increased significantly in the last two months we study, our leisure hour average will underestimate leisure time in those two months and result in an underestimate of infections. The upshot: for our procedure to be accurate, we would want the percent of time spent in each setting to remain consistent. With this in mind, we looked at ATUS data from April 2020 to December 2021 to look at time spent in each setting per month:

```{r}
time_date <- atusact %>%
  filter(date > "Mar 2020") %>%
  dplyr::group_by(date,top_location,top_category,caseid,weight) %>%
  dplyr::summarise(time = sum(duration)/60) %>%
  ungroup() %>%
  complete(nesting(date,caseid,weight,top_category),top_location,fill=list(time=0)) %>%
  group_by(date,top_location,top_category) %>%
  dplyr::summarise(time = weighted.mean(time,weight)) %>%
  filter(time > 0)

time_date %>%
  ggplot(aes(x=date,y=time,color=top_location)) + 
  geom_line() + 
  facet_wrap(~top_category) + 
  theme_bw() + 
  labs(x="Date",y="Avg. number of hours",title = "Time in each setting by group") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + 
  theme(text = element_text(family = "Georgia",size=12)) +
  scale_color_manual(name="Setting",values=wes_palette(n=3, name="FantasticFox1",type="continuous")) 
```

Visually, the hours seem stable to me, but I'd love to get your thoughts. Looking at the variance of these monthly averages:

```{r}
time_date %>%
  dplyr::group_by(top_category,top_location) %>%
  dplyr::summarise(variance = var(time)) %>%
  kable()
```

### 3.2. Relative risk: Idenitifying risk-takers and risk-averse respondents
#### 3.2.1. YouGov data overview
Next, because the risk of an hour spent in a setting depends on whether respondents practice preventive behaviors, we obtain an estimate of whether the respondent is a risk-taker or is risk-averse. 

While the Pulse does not contain data on respondents’ preventative behavior, it does contain questions on their beliefs about COVID-19 vaccines which have been shown to be correlated with preventive-behavior habits. For example, a KFF report finds that unvaccinated adults “are more likely to say they are not worried they personally will get seriously sick from the coronavirus” and were much less likely than vaccinated adults to report that the Delta variant made them more likely to wear a mask or avoid large gatherings. Thus, we create the following prediction model using relevant variables available in both the YouGov and Pulse surveys:


DISCUSSION ABOUT RISK IN THE WORKPLACE ETC

The YouGov survey contains the following relevant variables for risky behavior during leisure:

"Thinking about the last 7 days... how often have you taken the following measures to protect yourself or others from coronavirus? As a reminder, please exclude any measures that you have already taken for reasons other than coronavirus."

1. **washed_hands:** "...Washed hands with soap and water"
2. **hand_sanitizer:** "...Used hand sanitiser"
3. **avoid_contact_covid:** "...Avoided contact with people who have symptoms or you think may have been exposed to the coronavirus"
4. **avoid_public_transit:** "...Avoided taking public transport"
4. **avoid_guests:** "...Avoided having guests to your home"
5. **avoid_gatherings_small:** "...Avoided small social gatherings (not more than 2 people)"
6. **avoid_gatherings_medium:** "...Avoided medium-sized social gatherings (between 3 and 10 people)"
7. **avoid_gatherings_large:** "...Avoided large-sized social gatherings (more than 10 people)"
8. **avoid_shops:** "...Avoided going to shops"
9. **avoid_public_events:** "...Avoided attending public events, such as sports matches, festivals, theatres, clubs, or going to religious services"
10. **avoid_hh_indoors:** "...Avoided mixing with other households indoors"
11. **maskgrocery:** "...Worn a face mask inside a grocery store / supermarket"
12. **maskclotheshop:** "...Worn a face mask inside a clothing / footwear shop"
13. **masktransit:** "...Worn a face mask on public transportation"


Our current method uses the last three variables (maskgrocery, maskclotheshop, and masktransit) to categorize respondents as risky or not risky. We want to make sure our measure of risky behavior pertains exclusively to the leisure setting, so we excluded the question *1.Thinking about the last 7 days, how often have you worn a face mask at your place of work?*. However, it is still possible that questions 2-4 are contaminated by work-specific behavior if the respondent works in these settings (grocery store, footwear shop, etc). To get around this issue, we identify workers who are likely to work in these locations based on the job they indicated on the survey and treat their answer to the respective location question as missing, imputing it on the basis of other responses. 

The following answer choices are available for these questions:

* Always
* Frequently
* Sometimes
* Rarely
* Not at all

Ideally, if someone rarely or does not at all wear a mask in these settings, we would know they are risk-takers. However, we are concerned that someone might select these options because they haven't been to the setting. To give an example, if someone says they haven't at all worn a mask in public transport we want to know if this is because they are risky or because they simply haven't been on public transport. To figure this out, we use the question: *“Thinking about the last 7 days... how often have you [avoided taking public transport] to protect yourself or others from coronavirus? As a reminder, please exclude any measures that you have already taken for reasons other than coronavirus.”*

Our goal is to use this question to figure out if someone has taken public transport the last 7 days. If we think they have, then they must indicate to have worn a mask at least some of the time. However, if they have not, then their mask-wearing behavior in the setting becomes irrelevant.

Responses ‘always’ and ‘not at all’ seem to me as the most straight-forward to interpret:

* Always
    - Person who has not taken public transport because they are being covid-cautious. This person would be considered risk-averse,
        + One issue you raised was that someone might "avoid" public transport for reasons other than covid (e.g., they have a car and drive everywhere) so
        they might *not* actually be risk averse even if they're never in the setting. Yet, I think the way the question is asked helps us avoid the problem
        by explicitly asking respondents to "exclude any measures that you have already taken for reasons other than coronavirus". So, if someone does not
        take public transport because they have a car, their response to the question "Avoided taking public transport" would be "not at all". 
* Not at all
    - Person who has taken public transport with the same frequency as they would regardless of covid. This could mean:
        + They haven’t taken any public transport for other reasons (e.g., they have a car)
        + They have taken public transport as they normally would 


The responses “Frequently”, “Sometimes”, and “Rarely” are harder to interpret. The most straightforward example:

* Person who used to take the bus every single day but reduced their bus rides because of covid concerns. They didn’t reduce bus rides fully or else they would have said “Always” so we know they spent at least some time on the bus.
    - For example, person X used to take the bus to work 5 days a week, but due to covid concerns they were able to get a ride with a friend for 4 out of
    the 5 days. Because they spent *some* time on the bus, we would expect them to have worn a mask.

But the question is, do we also believe this slightly more convoluted example:

* Person who never used the bus this week but only some of the times due to covid concerns
    - For example, person X was going to take the bus on Wednesday, but the bus was delayed and person X was forced to walk. On Thursday, person X was going
    to ride the bus, but they got nervous about covid and decided to walk instead. 

I honestly don’t feel super worried about this kind of example. In general, my sense is that:

* someone who says they ‘frequently’, ‘sometimes’, or ‘rarely’ avoided taking public transport are people who spent at least some time on the bus. 
* someone who says they ‘always’ avoided taking public transport did not spend any time on the bus because they were worried about covid
* someone who did ‘not at all’ avoid taking public transport might have spent a lot of time on public transport or spent no time on it for reasons other
than covid concerns
    - this makes it the least informative response because we don’t know what to expect for mask behavior, and we don’t know whether they are risk-takers or
    not
    
Thus, for each setting we have three possibilities:

* Risk-averse: If they "Always", "Frequently", or "Sometimes" wear a mask and/or they "Always" avoided the setting
* Risk-taker: If they "Frequently", "Sometimes", or "Rarely" avoid the setting and "rarely" or "not at all" wear a mask
* Unknown: If they "Not at all" avoided the setting and "rarely" or "not at all" wear a mask

Now we want to know:

1. How do we categorize those "unknown" respondents?
2. Once we have risk-level for each setting, how do we categorize the respondent overall? If they are risky in one setting? If they are risky in two settings? Etc. 

To do this, I checked the different permutations of risk by setting with the average of the following variables (where always = 5 and not at all = 1)

1. washed_hands: "...Washed hands with soap and water"
2. hand_sanitizer: "...Used hand sanitiser"
3. avoid_contact_covid: "...Avoided contact with people who have symptoms or you think may have been exposed to the coronavirus"
4. avoid_guests: "...Avoided having guests to your home"
5. avoid_gatherings_small: "...Avoided small social gatherings (not more than 2 people)"
6. avoid_gatherings_medium: "...Avoided medium-sized social gatherings (between 3 and 10 people)"
7. avoid_gatherings_large: "...Avoided large-sized social gatherings (more than 10 people)"
8. avoid_public_events: "...Avoided attending public events, such as sports matches, festivals, theatres, clubs, or going to religious services"
9. avoid_hh_indoors: "...Avoided mixing with other households indoors"


```{r,message=FALSE,warning=FALSE}
clean_vars <- read.csv("data_files/cleanvariables/yougov/yougov_cleanvars.csv")
```

```{r}
yougov <- read.csv("data_files/yougov/yougov.csv") %>%
  dplyr::select(clean_vars$yougovname) %>% 
  purrr::set_names(clean_vars$newname) %>%
  mutate(date = as.Date(substr(date,1,10),format="%d/%m/%Y")) %>% 
  filter(date >= "2020-06-24") %>%
  mutate(risky_shop = ifelse(maskclotheshop %in% c("Always","Frequently","Sometimes") | avoid_shops == "Always",0,
                                      ifelse(maskclotheshop == "Not at all" & avoid_shops == "Not at all",-1,1)),
         risky_grocery = ifelse(maskgrocery %in% c("Always","Frequently","Sometimes") | avoid_shops == "Always",0,
                                ifelse(maskgrocery == "Not at all" & avoid_shops == "Not at all",-1,1)),
         risky_transport = ifelse(masktransit %in% c("Always","Frequently","Sometimes") | avoid_public_transit == "Always",0,
                                  ifelse(masktransit == "Not at all" & avoid_public_transit == "Not at all",-1,1)),)
```


```{r}
prep <- yougov %>%
  select(-clean_vars[clean_vars$type == "pred",]$newname) %>%
  mutate_all(as.character) %>%
  dplyr::mutate(id = row_number()) %>%
  gather(behavior,frequency,-risky_shop,-risky_grocery,-risky_transport,-id) %>%
  filter(frequency != " ") %>%
  dplyr::mutate(frequency = case_when(
                  frequency == "Always" ~ 5,
                  frequency == "Frequently" ~ 4,
                  frequency == "Sometimes" ~ 3,
                  frequency == "Rarely" ~ 2,
                  frequency == "Not at all" ~ 1)) %>%
  dplyr::mutate_at(c("risky_shop","risky_grocery","risky_transport"),
                   recode,
                   "1" = "Risky",
                   "0" = "Not risky",
                   "-1" = "Unknown") %>%
  mutate(combine = paste0("Shop:",risky_shop," + Grocery:",risky_grocery," + Transport:",risky_transport))
```


```{r}
prep %>%
  dplyr::group_by(risky_shop,risky_grocery,risky_transport,id) %>%
  dplyr::summarise(risky_avg = mean(frequency,na.rm = TRUE)) %>%
  dplyr::summarise(risky_avg = mean(risky_avg),
                   total = n()) %>%
  arrange(risky_avg) %>%
  kable()
```

Looking at the data, my instinct would be to recategorize "Unknown" as risky for each setting. Then, I would categorize any respondents with two or more risky settings as risky overall (eg, choose based on majority). Doing this we obtain the following totals:


```{r}
yougov <- yougov %>% 
  mutate_all(as.character) %>%
  mutate(risky_shop = ifelse(risky_shop == "-1","1",risky_shop),
         risky_grocery = ifelse(risky_grocery == "-1","1",risky_grocery),
         risky_transport = ifelse(risky_transport == "-1","1",risky_transport)) %>%
  mutate(is_risky = ifelse(as.numeric(risky_shop) + as.numeric(risky_grocery) + as.numeric(risky_transport) >= 2,1,0))
```

#### 3.2.2. Risky behavior sanity checks

Now, looking at different behaviors by group:

```{r}
yougov %>% 
  select(avoid_contact_covid,
       avoid_gatherings_small,
       avoid_gatherings_medium,
       avoid_gatherings_large,
       avoid_guests,
       avoid_hh_indoors,
       avoid_public_events,
       hand_sanitizer,
       washed_hands,
       risky_shop,
       risky_grocery,
       risky_transport,
       is_risky) %>%
  gather(behavior,frequency,-risky_shop,-risky_grocery,-risky_transport,-is_risky) %>%
  filter(frequency != " ") %>%
  dplyr::mutate(is_risky = as.factor(is_risky),
                frequency = factor(frequency,
                                   levels = c("Not at all","Rarely","Sometimes","Frequently","Always"))) %>%
  dplyr::group_by(is_risky,behavior,frequency) %>%
  dplyr::summarise(count = n()) %>%
  dplyr::mutate(total = sum(count),
                percent = count / total,
                is_risky = ifelse(is_risky == 1,"Risk-taker","Risk-averse")) %>%
  ggplot(aes(x=frequency,y=percent,fill=is_risky)) + 
  geom_col(position = 'dodge') + 
  facet_wrap(~behavior) +
  theme_minimal() + 
  labs(x="Frequency",y="% of group",title = "Behavior by group") + 
  theme(text = element_text(family = "Georgia",size=9)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  scale_fill_brewer("Riskiness",palette="Set2")
```

Collapsing to look at averages where "Always" = 5 and "Not at all" = 1

```{r}
yougov %>% 
  dplyr::mutate(frequency = case_when(
                  frequency == "Always" ~ 5,
                  frequency == "Frequently" ~ 4,
                  frequency == "Sometimes" ~ 3,
                  frequency == "Rarely" ~ 2,
                  frequency == "Not at all" ~ 1),
                sum = percent * frequency) %>%
  dplyr::group_by(is_risky,behavior) %>%
  dplyr::summarise(score = sum(sum)) %>%
  spread(is_risky,score) %>%
  kable()
```

```{r}
yougov %>%
  mutate(is_risky = ifelse(is_risky==0,"Not Risky","Risky")) %>%
  group_by(is_risky) %>%
  dplyr::summarise(count = n()) %>%
  dplyr::mutate(percent = count/sum(count)) %>%
  kable()
```

[TALK ABOUT DEFINING RISK AVERSE VS RISK TAKER]

We estimate that around 80% of Americans were risk-averse during the time of the survey. To sanity check our estimate, we use a different survey conducted by the NYTimes on mask wearing behavior, obtaining a similar result:

```{r}
nytimes <- read_csv(url("https://raw.githubusercontent.com/nytimes/covid-19-data/master/mask-use/mask-use-by-county.csv"))
```

```{r}
pops <- get(data("county_census")) %>% 
  dplyr::rename("COUNTYFP" = "FIPS") %>%
  dplyr::mutate(COUNTYFP = as.numeric(COUNTYFP)) %>%
  select(COUNTYFP,POPESTIMATE2019)
```

```{r}
merge(nytimes,pops,by="COUNTYFP") %>%
  dplyr::mutate(risk_averse = FREQUENTLY + ALWAYS,
                risk_taker = NEVER + RARELY + SOMETIMES) %>%
  dplyr::summarise('Risk Averse %' = weighted.mean(risk_averse,POPESTIMATE2019,na.rm=TRUE),
                   'Risk Taker %' = weighted.mean(risk_taker,POPESTIMATE2019,na.rm=TRUE)) %>%
  kable()
```

#### 3.2.3. Risky behavior model

Having categorized YouGov respondents as risk-averse or risk-takers, we can create a prediction model using variables also available in the Pulse relating to whether a person is vaccinated or not, if they want to be vaccinated, and their general beliefs about the vaccine, and government/health authorities:

* isvax: Have you had the first or second doses of a Coronavirus (COVID-19) vaccine?
  + 0 = "No, neither"
  + 1 = "Yes, one dose" OR "Yes, two doses"

* wantsvax: If a Covid-19 vaccine were made available to me this week, I would definitely get it
  + 0 = 2, 3, 4, 5 (where 5 = strongly disagree)
  + 1 = 1 (where 1 = strongly agree)

* gov_skeptic: I believe government health authorities in my country will provide me with an effective COVID19 vaccine
  + 0 = 1, 2, 3 (where 1 = strongly agree)
  + 1 = 4, 5 (where 5 = strongly disagree)

* test_concerns: I have concerns there has not been enough testing of vaccines
  + 0 = No
  + 1 = Yes

* mistrustvax: How much do you trust COVID-19 vaccines?
  + 0 = 1, 2, 3 (where 1 = very much)
  + 1 = 4, 5 (where 5 = not at all)

* side_effects: I have concerns about side effects
  + 0 = No
  + 1 = Yes
  
* gen_vac_skeptic: I don't think a vaccine would be effective enough
  + 0 = No
  + 1 = Yes


**YouGov to Pulse vaccine variables**


YouGov Var Name | YouGov Description | Pulse Description
----------------|--------------------|------------------
wantsvax | If a Covid-19 vaccine were made available to me this week, I would definitely get it | Once a vaccine to prevent COVID-19 is available to you, would you
gov_skeptic | I  believe government health authorities in my country will provide me with an effective COVID19 vaccine | I don’t trust the government
test_concerns | I have concerns there has not been enough testing of vaccines | I plan to wait and see if it is safe and may get it later
mistrustvax | How much do you trust COVID-19 vaccines? | I don’t trust COVID-19 vaccines
side_effects | I have concerns about side effects |  I am concerned about possible side effects of a COVID-19 vaccine
gen_vac_skeptic | I don't think a vaccine would be effective enough | I don't think vaccines are beneficial


**Notes on relevant Pulse variables**

All Pulse phases contain the following question:
* **isvax:** Have you received a COVID-19 vaccine
  + 1 = Yes
  + 2 = No
  
If respondents say they've received the vaccine, they answer the follow-up question (variable = **all_doses**):

* Phase 3.1: Did you receive (or do you plan to receive) all required doses
  + 1 = Yes
  + 2 = No
  + -99 = Did not respond
* Phase 3.2: Did you receive (or do you plan to receive) all required doses
  + 1 = Yes, received all doses
  + 2 = Yes, plan to receive all required doses
  + 3 = No, don't plan to receive all required doses
  + -99 = Did not respond
* Phase 3.3 and 3.4: How many dose(s) of a COVID-19 vaccine have you received
  + 1 = 1 vaccination
  + 2 = 2 vaccinations
  + 3 = 3 vaccinations
  + 4 = 4 or more vaccinations
  + 5 = Don’t know
  + -99 = Did not respond

If respondents *haven't* received the vaccine (isvax == No), all Pulse phases answer the follow-up question:
* **wantsvax:** Once a  vaccine to prevent COVID-19 is available to you, would you…
  + 1 = Definitely get a vaccine
  + 2 = Probably get a vaccine
  + 3 = Be unsure about getting a vaccine
  + 4 = Probably NOT get a vaccine
  + 5 = Definitely NOT get a vaccine
  + -99 - Did not respond

The questions we use to obtain our predictors (gov_skeptic, mistrust_vax, side_effects) are only asked if:

* Phase 3.1 and 3.2: Person has not received all doses (i.e., isvax == No or all_doses == No) and they *did not* say they'd definitely get a vaccine (wantsvax != 1)
* Phase 3.3 and 3.4: Person has not received the vaccine (isvax == No), regardless of doses, and they do not definitely want the vaccine (wantsvax != 1)

In line with this, we set our relevant variables as follows:

* isvax
  + Phase 3.1 and 3.2: Yes if received or planned to received all required doses
  + Phase 3.3 and 3.4: Yes if received a vaccine
* wantsvax
  + All phases: Yes if haven't received a vaccine but will definitely get a vaccine
* mistrust_vax, gov_skeptic, side_effects: Can only be set to "Yes" if person hasn't received a vaccine and doesn't want to
* other: Set to "Yes" if person doesn't want vaccine but for reasons outside of those in these variables

We follow this same logic when setting YouGov variables:

* wantsvax is only set to "Yes" if person "Strongly agrees" that they'd definitely get the vaccine
* variables gov_skeptic, mistrust_vax, side_effects, and other are automatically set to "No" if person wants vaccine



```{r}
yougov <- yougov %>% 
  filter(date > "2021-04-06") %>%
  dplyr::filter(isvax != " ") %>%
  dplyr::mutate(wantsvax = substr(wantsvax,1,1)) %>% 
  dplyr::mutate(isvax = ifelse(isvax %in% c("Yes, one dose","Yes, two doses"),"Yes","No")) %>%
  dplyr::mutate(wantsvax = ifelse(wantsvax %in% c(1,2) & isvax == "No","Yes","No")) %>%
  dplyr::mutate(gov_skeptic = substr(gov_skeptic,1,1)) %>% 
  dplyr::mutate(gov_skeptic = ifelse(gov_skeptic %in% c("4","5"),"Yes","No")) %>%
  dplyr::mutate(mistrust_vax = ifelse(mistrust_vax %in% c("A little","Not at all"),"Yes","No")) %>%
  dplyr::mutate(side_effects = as.character(side_effects)) %>%
  dplyr::mutate(side_effects = ifelse(side_effects == "Yes","Yes","No"))
```

```{r}
yg <- yougov %>%
  mutate(vax = case_when(
    isvax == "Yes" ~ "IsVax",
    wantsvax == "Yes" ~ "WantsVax",
    TRUE ~ "NoVax"
  )) %>%
  mutate(have_info = ifelse(vax == "NoVax",0,1))
```



#### 3.2.4. Running prediction models

```{r}
risky_model<- glm(is_risky ~
                    vax +
                    mistrust_vax + 
                    gov_skeptic +
                    side_effects,
                    yg,
                    family = "binomial")
summary(risky_model)
```

Now, we can apply the model to the Pulse data to make predictions. First, we recode Pulse data to match the model's input:

```{r}
pulse <- pulse %>%
  mutate(alldoses = ifelse(isvax == "No","No",as.character(alldoses))) %>%
  mutate(isvax = ifelse(isvax == "Yes" & alldoses != "No","Yes","No")) %>%
  mutate(wantsvax = ifelse(wantsvax == "Yes","Yes","No")) %>%
  mutate(gov_skeptic = ifelse(gov_skeptic == 1,"Yes","No")) %>%
  mutate(side_effects = ifelse(side_effects == 1,"Yes","No")) %>%
  mutate(mistrust_vax = ifelse(mistrust_vax == 1,"Yes","No"))
```

```{r}
pulse <- pulse %>%
  mutate(vax = case_when(
    isvax == "Yes" ~ "IsVax",
    wantsvax == "Yes" ~ "WantsVax",
    TRUE ~ "NoVax"
  ))
```

Let's add age, state, education level

```{r}
preds <- predict(risky_model,pulse,type="response")
pulse$risky_pred <- preds
```

For now, let's assume that anyone with more than a 25% of being risky is risky:

```{r}
pulse %>%
  dplyr::group_by(vax,gov_skeptic,side_effects,mistrust_vax,risky_pred) %>%
  dplyr::summarise(count=sum(weight)) %>%
  arrange(-risky_pred) %>%
  ungroup() %>%
  mutate(percent_of_pop = count/sum(count)) %>%
  select(-count)
```

```{r}
pulse$is_risky <- ifelse(pulse$risky_pred > 0.25, 1, 0)
```

We can use YouGov to estimate the proportion at each month? Or something like that. And then we can use that to set the threshold. 
Add more gradiation on the 'wanting infection' variable (don't make binary)

### 3.3. Risky behavior multiplier
[Discussion about which model to use]
Having estimated whether someone wears a mask in leisure settings, we want to know how much riskier not wearing a mask is while at leisure. We obtain this risk multiplier using this Nature study of 198,077 US participants which finds that self-reported ‘sometimes’, ‘most of the time’, and ‘always’ use of face mask was associated with an average 68% reduced risk of predicted COVID-19 compared to individuals who wore face masks none of the time. Findings are consistent with this CDC study that finds mask wearing reduced risk of infection by 70%. In line with the Nature study, we say that, for risk-takers, a hour spent at leisure is 3.125 (1/0.32) times riskier.

### 3.4. Relative risk: People in household

If someone lives alone we assign a risk multiplier of 0 because hours spent alone at home are not risky. We use the Pulse question, *How many total people (adults and children) currently live in your household, including youself?* to set the binary varibale, **lives_with_others**

```{r}
pulse$lives_with_others <- ifelse(pulse$num_household > 1,1,0)
```


### 3.5. Relative risk: Split Pulse data

To recap: we are ultimately interested in understanding risk specific to the workplace, so we want to distribute infections between those occurring at work, leisure, or at home. If a Pulse respondent had covid and we believed they were equally likely to have gotten it in any of the settings, we would simply attribute 1/3 of the infection to each. Instead, we believe that the likelihood an infection occured in the setting is a function of how much time they spend there and how risky they are in the setting. We gathered three pieces of information:

1. Time in each setting by work category (ATUS)
2. Risky behavior during leisure hours (YouGov + Pulse)
3. People in household (Pulse)

We assume that if someone is risky, an hour spent at leisure is 3.125 times riskier. We also assume that if someone lives alone, there is 0 risk in their household setting. 

To capture risk specific to each setting in our model, we create three subrespondents for every respondent: a “work respondent,” a “leisure respondent,” and a “home respondent”. Each subrespondent is given a weight of one-third. 

We create an infection variable (I) with four categories:

* no infection
* infection at home
* infection at work
* infection at leisure

For a respondent who reports to Pulse that they’ve not been infected, all three subrespondents fall into the “no infection” category in our infection variable (I). For a respondent who reports to Pulse that they have been infected, the work subrespondent will fall into the “infection at work” category, the leisure subrespondent will fall into the “infection at leisure” category, and the home subrespondent will fall into the “infection at home” category. Because we don’t want to distribute an infection equally across each setting, we take the following steps to subdivide the single infection into shares reflecting the likelihood that the infection occurs in each setting:

1.	Assign number of hours in each setting 
2.	Assign risk multiplier for each setting
3.	Calculate the “proportion” of the infection occurring in a given setting by multipliying hours in the setting by the riskiness multiplier and dividing by total, risky-adjusted hours.
4.	Multiply each proportion by 3 so weighted infections still sum to 1. 

For example, for a Pulse respondent who is risky during leisure and lives alone: 

Respondent | Weight | Time setting | Risky multiplier | No infection | Home covid | Work covid | Leisure covid
-----------|--------|--------------|------------------|--------------|------------|------------|--------------
HomeResp   | 1/3    | 12           | 0                | 0            | 0          | 0          | 0
LeisureResp| 1/3    | 4            | 3.125            | 0            | 0          | 0          | 1.83
WorkResp   | 1/3    | 8            | 1                | 0            | 0          | 1.17       | 0

We create a measure of past covid contraction using the following Pulse survey question:

* Has a doctor or other health care provider ever told you that you have COVID-19? 
  + 1. Yes
  + 2. No
  + 3. Not sure

"Yes" responses are marked as having had Covid-19 and given a 1, while "No" and "Not sure" are both marked as never having had Covid and given a 0.

```{r}
pulse <- pulse %>%
  filter(had_covid > 0) %>%
  dplyr::mutate(split_weight = 1/3,
         id = row_number())
split_pulse <- rbind(pulse %>% mutate(respondent = "HomeResp"),
        pulse %>% mutate(respondent = "LeisureResp"),
        pulse %>% mutate(respondent = "WorkResp"))
```

```{r}
split_pulse <- split_pulse %>%
  mutate(time_setting = case_when(
    respondent == "HomeResp" ~ Time_At_Home,
    respondent == "LeisureResp" ~ Time_At_Leisure,
    respondent == "WorkResp" ~ Time_At_Workplace,
    respondent == "WorkResp" ~ Time_At_Workplace,
  ),
  risky_multiplier = case_when(
    respondent == "HomeResp" ~ lives_with_others,
    respondent == "WorkResp" ~ 1,
    respondent == "LeisureResp" & is_risky == 1 ~ 3.125,
    respondent == "LeisureResp" & is_risky == 0 ~ 1
  ),
  had_covid = ifelse(had_covid == 1,1,0),
  no_infection = abs(had_covid-1),
  home_covid = ifelse(respondent == "HomeResp",
                      had_covid * time_setting * risky_multiplier,0),
  work_covid = ifelse(respondent == "WorkResp",
                      had_covid * time_setting * risky_multiplier,0),
  leisure_covid = ifelse(respondent == "LeisureResp",
                         had_covid * time_setting * risky_multiplier,0)) %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(total = sum(home_covid + work_covid + leisure_covid + no_infection)) %>%
  dplyr::mutate(home_covid = home_covid/total * 3,
                work_covid = work_covid/total * 3,
                leisure_covid = leisure_covid/total * 3,
                no_infection = no_infection/total * 3)
```

As a sanity check, we want to make sure we obtain the same number of covid infections and respodents without covid:

```{r}
pulse %>%
  mutate(covid = ifelse(had_covid == 1,"covid","nocovid")) %>%
  dplyr::group_by(covid) %>%
  dplyr::summarise(count = n())
```

```{r}
split_pulse %>%
  mutate(covid = (home_covid + leisure_covid + work_covid)*split_weight,
         nocovid = no_infection * split_weight) %>%
  summarise(covid = sum(covid),
            nocovid = sum(nocovid))
```

Now, looking at covid in each of the settings:

```{r}
split_pulse %>%
  summarise(home = sum(home_covid * split_weight),
            work = sum(work_covid * split_weight),
            leisure = sum(leisure_covid * split_weight)) %>%
  mutate(total=home+work+leisure)
```

Exporting Pulse data with split respondents:

```{r}
write.csv(split_pulse,"data_files/pulse/processed/split_pulse.csv")
```


### Relative risk: Compute relative risk model

```{r}
colnames(split_pulse)
```
```{r}
df <- split_pulse %>%
  select(race_ethnicity)
```

```{r}
count(pulse$race_ethnicity)
```


```{r}
df <- df %>% 
  gather(Type,Infected,-Weight,-Job) %>%
  mutate(Weight = Infected * Weight) %>%
  select(-Infected) %>%
  filter(Weight > 0)
```

### Relative to absolute risk: CDC total infections by race and state
### Relative to absolute risk: Job population estimates by race and state
### Relative to absolute risk: Total infections at home, leisure, and work
### Risk-of-infection: IPF to fit relative risk to known totals
### Risk-of-infection: Translate risk-of-infection to mild/moderate and severe infection


